import requests, sys, csv, datetime, os, time, re
import virustotal, glob

numbers = re.compile(r'(\d+)')
def numericalSort(value):
    parts = numbers.split(value)
    parts[1::2] = map(int, parts[1::2])
    return parts

def process_report(file, report, score_fieldnames, list_fieldnames):
    data = {}
    data['filename'] = file
    data['positives'] = report.positives
    data['total'] = report.total
    with open('output/malware_score.csv', 'a') as f:
        w = csv.DictWriter(f, fieldnames = score_fieldnames)
        w.writerow(data)
    f.close()

    data = {}
    data['filename'] = file
    for antivirus, malware in report:
        if malware is None:
            data[antivirus[0]] = 0
        else:
            data[antivirus[0]] = 1

    with open('output/malware_list.csv', 'a') as f:
        w = csv.DictWriter(f, fieldnames = list_fieldnames)
        w.writerow(data)
    f.close()

def extract(dirname):
    
    if os.path.isdir(os.path.join(os.getcwd())+'/input') == False:
        os.mkdir('input')
        
    if os.path.isdir(os.path.join(os.getcwd())+'/output') == False:
        os.mkdir('output')
    
    score_fieldnames = ['filename', 'positives', 'total']
    malware_score_file = open('output/malware_score.csv', 'w')
    with malware_score_file:
        writer = csv.DictWriter(malware_score_file, fieldnames=score_fieldnames)
        writer.writeheader()
    malware_score_file.close()
    
    list_fieldnames = ['filename', u'Bkav', u'TotalDefense', u'MicroWorld-eScan', u'CMC', u'CAT-QuickHeal', u'McAfee',
    u'Malwarebytes', u'VIPRE', u'TheHacker', u'BitDefender', u'K7GW', u'K7AntiVirus', u'Baidu',
    u'NANO-Antivirus', u'Cyren', u'SymantecMobileInsight', u'Symantec', u'ESET-NOD32', u'TrendMicro-HouseCall',
    u'Avast', u'ClamAV', u'GData', u'Kaspersky', u'Alibaba', u'Babable', u'ViRobot', u'AegisLab', u'Tencent',
    u'Ad-Aware', u'Trustlook', u'Sophos', u'Comodo', u'F-Secure', u'DrWeb', u'Zillya', u'TrendMicro',
    u'McAfee-GW-Edition', u'Emsisoft', u'Ikarus', u'F-Prot', u'Jiangmin', u'Avira', u'Antiy-AVL', u'Kingsoft',
    u'Arcabit', u'SUPERAntiSpyware', u'ZoneAlarm', u'Avast-Mobile', u'Microsoft', u'AhnLab-V3', u'ALYac',
    u'AVware', u'TACHYON', u'VBA32', u'Zoner', u'Rising', u'Yandex', u'MAX', u'Fortinet', u'AVG', u'Panda',
    u'Qihoo-360', u'Webroot']

    antivirus_detail_file = open('output/malware_list.csv', 'w')
    with antivirus_detail_file:
        writer = csv.DictWriter(antivirus_detail_file, fieldnames=list_fieldnames)
        writer.writeheader()
    antivirus_detail_file.close()

    api_key = '22f5800f35d83ec0247e6b1802d055a0541012eac3217bb5c8668583ee828a34'
    v = virustotal.VirusTotal(api_key)
    
    path = 'input/'+dirname + '/'
    for file in sorted(glob.glob(os.path.join(path, '*.apk')), key=numericalSort):
        print 'Scanning the file: ', file.split('/')[2]
        report = v.get(file)
        process_report(file.split('/')[2], report, score_fieldnames, list_fieldnames)
        print 'Done'
    print 'Scanning completed'